# Ollama 複数ホスト指定機能 要件定義

## 背景
現在の CLI / エージェント実装では、環境変数 `APP_OLLAMA_URL` を通じて単一の Ollama エンドポイントのみを指定できる。複数のモデルを異なるホストで運用している場合や、一部モデルのみクラウド環境を利用したいケースでは柔軟性が不足している。

## ゴール
- 各モデル呼び出しごとに接続先ホストを切り替えられるようにし、複数の Ollama サーバーを同時利用できる。
- 既存の CLI オプションやワークフロー構造を大きく変えずに導入できる。
- デフォルト挙動は後方互換性を保持し、環境変数・設定未指定でもローカルホストへ接続できる。

## スコープ
- TypeScript 側 (`chatWithOllama`, `Agent`, `orchestrateWorkflow` 等) の接続先決定ロジック。
- CLI からモデルを指定する際のホスト指定方法（案: `model@host` 形式、または別 CLI オプション）。
- 環境変数の拡張 (`APP_OLLAMA_URL`, `APP_OLLAMA_URL_<ALIAS>` など) の検討。
- ユニットテスト / 統合テストでの接続先選択検証。
- ドキュメント更新 (README, サンプル設定, 運用ガイド)。

## 非スコープ
- 新しい認証/認可機構の導入。
- Ollama 側の設定手順変更。
- Python スクリプトでの直接的な API 呼び出し変更 (TypeScript CLI を経由する範囲で対応)。

## ユースケース
1. **モデルごとにホストを選択**: `modelA` はローカル、`modelB` はリモート環境で提供したい。
2. **一時的なフェイルオーバー**: 環境変数でデフォルトホストを指示しつつ、CLI オプションで一部モデルのみ別ホストへ切り替え。
3. **CI でのリモート利用**: CI 環境では `APP_OLLAMA_URL` 未設定とし、全モデルが `http://localhost:11434` にフォールバックする。

## 機能要件
- R1: モデル指定に接続先ホスト情報を含められること。
- R2: 接続先ホスト未指定の場合は `APP_OLLAMA_URL` の値を使用すること。
- R3: `APP_OLLAMA_URL` が未定義の場合は `http://localhost:11434` にフォールバックすること。
- R4: モデルごとのホスト指定と既存のワークフロー/スクリプト引数 (例: `model1`, `model2`) が両立すること。
- R5: JSON 出力モードでデバッグログを抑制する現状の仕様が保持されること。

## 非機能要件
- N1: ホスト指定のパースは大文字・小文字を区別せずに動作し、URL 正規化を行う。
- N2: 接続先が不達の場合、どの URL を試行したかがエラーメッセージに含まれる。
- N3: 既存のテストラン (npm test) に新たな失敗を導入しない。

## 受け入れ条件案
- AC1: `npm start --user-prompt ... llama3:8b@https://remote.example.com llama3:8b` のようなコマンドで、1 番目のモデルのみリモートへ接続する。
- AC2: 環境変数未設定時に CLI が `http://localhost:11434` を利用し、ログに接続先が記録される。
- AC3: `APP_OLLAMA_URL` を設定しつつ、モデル文字列にホストが含まれる場合はモデル側の指定が優先される。
- AC4: ユニットテストでホストパース・フォールバックが検証されている。

## 開放課題
- モデルとホストのマッピングを設定ファイルで定義するか、CLI のみでカバーするか。
- 既存ワークフロー定義内でモデル ID をホスト込みにすべきか、変換層を用意するか。
- Python スクリプト (`ab_test_runner.py` など) からの指定方法 (別タスクで調整が必要)。

