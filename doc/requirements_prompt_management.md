# プロンプト管理機能 要件定義書

## 1. 目的

本要件定義書は、LLMエージェントが使用するプロンプトの外部化と管理を容易にすることで、A/Bテストの実施およびプロンプトエンジニアリングの効率化を図ることを目的とする。

## 2. 背景

現在の実装では、プロンプトがソースコード (`src/prompts.ts`) にハードコードされており、プロンプトの変更やA/Bテストの実施が困難である。特に、ユーザープロンプトへの追従性など、プロンプトエンジニアリングで解決が図れる課題が見つかっており、プロンプトの差し替えを容易にする仕組みが求められている。

## 3. 要件

### 3.1. プロンプトの外部化

*   **REQ-PM-001**: プロンプトはソースコードから分離し、外部ファイルとして管理されること。
*   **REQ-PM-002**: プロンプトファイルはJSON形式であること。
    *   **理由**: 編集容易性、人間可読性、LLMからの編集時の誤読防止を重視するため。
*   **REQ-PM-003**: プロンプトファイルはプロジェクトルート直下の `prompts/` ディレクトリに配置されること。
*   **REQ-PM-004**: プロンプトファイルは、複数のプロンプト定義を含むことができること。

### 3.2. プロンプトファイルの構造

*   **REQ-PM-005**: 各プロンプトファイルは、以下のトップレベルプロパティを持つこと。
    *   `format_version`: プロンプトファイルのフォーマットバージョンを示す文字列（例: "1.0"）。
    *   `prompts`: プロンプト定義の配列。
*   **REQ-PM-006**: `prompts` 配列内の各プロンプト定義は、以下のプロパティを持つこと。
    *   `id`: プロンプトを一意に識別するための文字列。
    *   `description`: プロンプトの内容を人間が理解しやすいように説明する文字列。
    *   `content`: 実際のプロンプトテキストを含む文字列。
*   **REQ-PM-007**: プロンプトファイルは、可読性を高めるために適切に整形（インデントなど）されていること。

**プロンプトファイル例:**

```json
{
  "format_version": "1.0",
  "prompts": [
    {
      "id": "thought_agent_default",
      "description": "思考者エージェント用デフォルトプロンプト",
      "content": "あなたは思考者です。ユーザーのプロンプトに対して素の思考で回答してください。"
    },
    {
      "id": "reviewer_agent_default",
      "description": "批判的レビュアーエージェント用デフォルトプロンプト",
      "content": "あなたは批判的レビュアーです。思考者の回答を批判的にレビューし、改善点を見つけてください。"
    }
  ]
}
```

### 3.3. プロンプトの選択と設定

*   **REQ-PM-008**: 使用するプロンプトファイルは、テキストベースの設定ファイルによって指定されること。
    *   **理由**: A/Bテストの履歴を残しやすくするため。
*   **REQ-PM-009**: 設定ファイルは、プロジェクトルート直下の `config/` ディレクトリに配置されること。
*   **REQ-PM-010**: 設定ファイルは、`prompt_file_path` プロパティを持ち、使用するプロンプトファイルへの相対パスを指定すること。
*   **REQ-PM-011**: 設定ファイルで `prompt_file_path` が指定されない場合、`prompts/default_prompts.json` をデフォルトのプロンプトファイルとして使用すること。
*   **REQ-PM-012**: エージェントの役割ごとに異なるプロンプトを指定する機能は、今回の要件では不要とする。
    *   **現状**: 現在の実装では、`agent_roles` 定義を通じてエージェントごとにシステムプロンプトを指定できるようになり、この要件は解決済みです。

**設定ファイル例:**

```json
{
  "prompt_file_path": "prompts/my_ab_test_prompts.json"
}
```

### 3.4. 編集容易性

*   **REQ-PM-013**: プロンプトファイルおよび設定ファイルは、テキストエディタで直接編集できること。
*   **REQ-PM-014**: プロンプトテキスト内で動的な値を埋め込むテンプレート機能は不要とする。
    *   **理由**: 今回のプロンプトは役割と作業内容を定義するシステムプロンプトであり、動的な埋め込みは想定されないため。

## 4. 今後の検討事項

*   設定ファイルの形式はJSONとする。
*   プロンプトファイルの読み込みとパース処理の実装詳細。
*   エラーハンドリング（プロンプトファイルが見つからない、JSON形式が不正など）。
*   CLIからの設定ファイル指定方法。
