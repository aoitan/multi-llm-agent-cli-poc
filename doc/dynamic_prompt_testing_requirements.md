# 動的プロンプトテストの要件

## 概要

ユーザープロンプトの内容に応じて内部プロンプトを動的に変更し、LLMの応答品質が改善されるかを検証するためのA/Bテストの要件を定義する。このテストは、最近実装された柔軟なプロンプトメカニズムを最大限に活用することを目的とする。

## 1. 内部プロンプトの設計

動的なプロンプトの選択と構築を可能にするため、以下の点を考慮する。

*   **プロンプトのモジュール化:**
    *   プロンプトをより小さな、再利用可能なコンポーネント（例：指示、制約、出力形式、例）に分割し、これらを組み合わせて最終的なプロンプトを構築できるようにする。
    *   これにより、ユーザープロンプトやシナリオに応じて、これらのコンポーネントを動的に選択・組み合わせることが可能になる。
*   **変数とプレースホルダー:**
    *   プロンプト内で使用する変数を明確に定義し、`fillTemplate` 関数で埋め込めるようにする。
    *   必要に応じて、新しい種類のプレースホルダーを導入し、実行時に特定のロジックに基づいて内容を挿入できるようにする。
*   **条件付きロジックのサポート:**
    *   プロンプトの選択や生成に条件付きロジックを導入するためのメカニズムを検討する（例：ワークフロー定義内での条件分岐、プロンプトローダーの拡張）。

## 2. シナリオに応じたプロンプトセットとフローの選択

`scripts/prompts_config.py` で定義されている既存のシナリオと、`config/workflow_config.json` で定義されているワークフローを基盤とする。

*   **シナリオの識別:**
    *   ユーザープロンプトを解析し、どのシナリオに該当するかを識別するロジックを実装する（例：キーワードマッチング、正規表現、LLMによる分類）。
    *   `scripts/prompts_config.py` に、シナリオとそれに対応するプロンプトセット/ワークフローのマッピングを定義するセクションを追加する。
*   **プロンプトセットの定義:**
    *   各シナリオに対して、異なるエージェントの役割定義やプロンプトの組み合わせを「プロンプトセット」として定義する。
    *   シナリオごとに異なるプロンプトファイルを準備するか、または単一の `default_prompts.json` 内でシナリオごとのセクションを設けるかを検討する。
*   **ワークフローの選択/適応:**
    *   シナリオに応じて、`workflow_config.json` から適切なワークフローを選択するロジックを実装する。
    *   あるいは、単一のワークフロー内で、シナリオに応じて異なるステップやエージェントのパスを条件付きで実行するロジックを導入する。

## 3. 評価指標

A/Bテストで改善を測定するためには、明確な評価指標を設定する。

*   **定量的指標:**
    *   **タスク完了率:** 特定のタスク（例：コードレビュー、要約）がどれだけ正確に完了したか。
    *   **応答の長さ/簡潔さ:** 応答が適切に簡潔であるか。
    *   **特定のキーワード/フレーズの出現率:** 応答に特定の必須キーワードやフレーズが含まれているか。
    *   **構造化された出力の正確性:** JSONなどの構造化された出力が、定義されたスキーマにどれだけ準拠しているか。
*   **定性的な指標 (手動評価):**
    *   **関連性:** 応答がユーザーの意図にどれだけ関連しているか。
    *   **正確性:** 応答に含まれる情報がどれだけ正確か。
    *   **網羅性:** 応答がユーザーの要求をどれだけ網羅しているか。
    *   **一貫性:** 応答全体で論理的な一貫性が保たれているか。
    *   **ユーザー満足度:** 応答がユーザーの期待をどれだけ満たしているか。

## 4. 作業手順の概要

1.  **シナリオの特定と定義:** `scripts/prompts_config.py` を拡張し、テストしたい具体的なシナリオと、それらを識別するためのルール（例：ユーザープロンプトのキーワード）を定義する。
2.  **動的プロンプトの設計と実装:**
    *   シナリオごとに異なるプロンプトセットを作成する。
    *   `src/utils/promptLoader.ts` や `src/agent.ts` を修正し、ユーザープロンプトに基づいて適切なプロンプトセットをロードし、必要に応じてプロンプトを動的に構築するロジックを追加する。
3.  **ワークフローの適応:** `src/index.ts` や `src/utils/workflowLoader.ts` を修正し、シナリオに応じて適切なワークフローを選択または適応するロジックを追加する。
4.  **A/Bテストの設定:** `config/ab_test_config.json` を使用して、動的プロンプトを有効にしたテストグループと、既存の静的プロンプトを使用するコントロールグループを設定する。
5.  **評価スクリプトの作成/更新:** `scripts/generate_reports.py` などを更新し、定義した評価指標に基づいてA/Bテストの結果を分析できるようにする。
