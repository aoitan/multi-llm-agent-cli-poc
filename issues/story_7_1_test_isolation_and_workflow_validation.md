# ストーリー 7.1: テスト環境分離とワークフロー検証強化

## 概要
エピック「ワークフロー信頼性とモジュール整備」に属するストーリーです。本番リソースを破壊してしまうテストコードを隔離し、`orchestrateWorkflow` を中心としたワークフロー処理の自動テストを復活させます。テスト駆動で開発を進められるよう、テストの前提条件・期待結果を仕様として明確にします。

## 受け入れ条件
- [ ] `src/__tests__/scenarioIdentifier.test.ts` が本番の `config/scenario_config.json` を直接変更・削除しない。テスト実行後もリポジトリがクリーンな状態に保たれる。
- [ ] `src/__tests__/agent.test.ts` のメインスイートが有効化され、`orchestrateWorkflow` の正常系と言語ガード再指示分岐を検証している。
- [ ] テストデータのセットアップ/クリーンアップがユーティリティ化され、新しいシナリオやワークフローのテスト追加に再利用できる。
- [ ] CI での `npm test` 実行時に追加の環境構築手順が必要ないことを README または適切な場所で明記する。

## 進め方のガイド
- 一時ディレクトリ (`fs.mkdtemp`) や `memfs` を活用して設定ファイルをモックし、本番ファイルシステムとの分離を徹底してください。
- `chatWithOllama` モックの共通セットアップを `beforeEach` で与え、レスポンスシナリオをテストケースごとに切り替えられるようにすると TDD が行いやすくなります。
- ワークフロー仕様の網羅性を高めるため、正常系だけでなく閾値超過/未達などの境界条件をテストに含めてください。

## 関連タスク
* [ ] [タスク 7.1.1: シナリオ識別テストのファイル分離と安全なクリーンアップ](task_7_1_1_isolate_scenario_identifier_tests.md)
* [ ] [タスク 7.1.2: orchestrateWorkflow テストスイートの再有効化と拡張](task_7_1_2_restore_orchestrate_workflow_tests.md)
* [ ] [タスク 7.1.3: テストユーティリティ整備とドキュメント更新](task_7_1_3_test_utilities_and_docs.md)

## 依存関係 / リスク
- 既存テストの挙動が変わるため、CI 上でのジョブ設定変更が必要な場合は Ops チームと調整する。
- `chatWithOllama` のモック仕様変更が他テストにも影響する可能性があるため、変更範囲を明確にする。
